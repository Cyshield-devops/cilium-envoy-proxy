From bc0ec6bc47dea78a5e4c96d6741699c6d4b4f699 Mon Sep 17 00:00:00 2001
From: Jarno Rajahalme <jarno@isovalent.com>
Date: Thu, 6 Jan 2022 16:34:27 +0200
Subject: [PATCH] build: Cross-compilation fix for arm64

This change adds the possibility to cross-compile Envoy for aarch64
target on host by using a toolchain which defines "aarch64-cross"
platform.

Signed-off-by: Michal Rostecki <mrostecki@opensuse.org>
Signed-off-by: Jarno Rajahalme <jarno@isovalent.com>
---
 bazel/BUILD                  | 10 ++++++++++
 bazel/envoy_build_system.bzl |  7 +------
 bazel/foreign_cc/BUILD       | 18 ++++++++++++++++++
 3 files changed, 29 insertions(+), 6 deletions(-)

diff --git a/bazel/BUILD b/bazel/BUILD
index 98be980f8..3166470df 100644
--- a/bazel/BUILD
+++ b/bazel/BUILD
@@ -427,11 +427,21 @@ config_setting(
     values = {"cpu": "k8"},
 )
 
+config_setting(
+    name = "linux_x86_64_cross",
+    define_values = {"cross": "x86_64"},
+)
+
 config_setting(
     name = "linux_aarch64",
     values = {"cpu": "aarch64"},
 )
 
+config_setting(
+    name = "linux_aarch64_cross",
+    define_values = {"cross": "aarch64"},
+)
+
 config_setting(
     name = "linux_ppc",
     values = {"cpu": "ppc"},
diff --git a/bazel/envoy_build_system.bzl b/bazel/envoy_build_system.bzl
index 921e51af6..e65ba1a32 100644
--- a/bazel/envoy_build_system.bzl
+++ b/bazel/envoy_build_system.bzl
@@ -98,7 +98,7 @@ def envoy_cmake_external(
         copy_pdb = False,
         pdb_name = "",
         cmake_files_dir = "$BUILD_TMPDIR/CMakeFiles",
-        generate_crosstool_file = False,
+        generate_crosstool_file = True,
         **kwargs):
     cache_entries.update({"CMAKE_BUILD_TYPE": "Bazel"})
     cache_entries_debug = dict(cache_entries)
@@ -129,11 +129,6 @@ def envoy_cmake_external(
             "//conditions:default": cache_entries,
         }),
         cmake_options = cmake_options,
-        # TODO(lizan): Make this always true
-        generate_crosstool_file = select({
-            "@envoy//bazel:windows_x86_64": True,
-            "//conditions:default": generate_crosstool_file,
-        }),
         lib_source = lib_source,
         make_commands = make_commands,
         postfix_script = pf,
diff --git a/bazel/foreign_cc/BUILD b/bazel/foreign_cc/BUILD
index 12f5c7642..d2d7b7dcc 100644
--- a/bazel/foreign_cc/BUILD
+++ b/bazel/foreign_cc/BUILD
@@ -16,6 +16,8 @@ configure_make(
         "--disable-libunwind",
     ] + select({
         "//bazel:apple": ["AR=/usr/bin/ar"],
+        "//bazel:linux_aarch64_cross": ["--host aarch64-linux-gnu"],
+        "//bazel:linux_x86_64_cross": ["--host x86_64-linux-gnu"],
         "//conditions:default": [],
     }),
     lib_source = "@com_github_gperftools_gperftools//:all",
@@ -47,6 +49,14 @@ configure_make(
         "//bazel:asan_build": {"ENVOY_CONFIG_ASAN": "1"},
         "//bazel:msan_build": {"ENVOY_CONFIG_MSAN": "1"},
         "//bazel:windows_dbg_build": {"WINDOWS_DBG_BUILD": "debug"},
+        "//bazel:linux_aarch64_cross": {
+            "CC": "gcc",
+            "CROSS": "aarch64-linux-gnu-",
+        },
+        "//bazel:linux_x86_64_cross": {
+            "CC": "gcc",
+            "CROSS": "x86_64-linux-gnu-",
+        },
         "//conditions:default": {},
     }),
     lib_source = "@com_github_luajit_luajit//:all",
@@ -67,6 +77,14 @@ configure_make(
         # TODO(htuch): Remove when #6084 is fixed
         "//bazel:asan_build": {"ENVOY_CONFIG_ASAN": "1"},
         "//bazel:msan_build": {"ENVOY_CONFIG_MSAN": "1"},
+        "//bazel:linux_aarch64_cross": {
+            "CC": "gcc",
+            "CROSS": "aarch64-linux-gnu-",
+        },
+        "//bazel:linux_x86_64_cross": {
+            "CC": "gcc",
+            "CROSS": "x86_64-linux-gnu-",
+        },
         "//conditions:default": {},
     }),
     lib_source = "@com_github_moonjit_moonjit//:all",
-- 
2.34.0

