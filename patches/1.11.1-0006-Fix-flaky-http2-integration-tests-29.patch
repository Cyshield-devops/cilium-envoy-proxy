From f62ad1057ce0e60f46ac0a0c69308076a75011c3 Mon Sep 17 00:00:00 2001
From: yanavlasov <yavlasov@google.com>
Date: Fri, 2 Aug 2019 13:55:07 -0400
Subject: [PATCH 6/7] Fix flaky http2 integration tests (#29)

Signed-off-by: Yan Avlasov <yavlasov@google.com>
---
 test/integration/http2_integration_test.cc | 17 +++++++++++++++++
 test/integration/http2_integration_test.h  |  1 +
 2 files changed, 18 insertions(+)

diff --git a/test/integration/http2_integration_test.cc b/test/integration/http2_integration_test.cc
index eb2c080503..7923a5880e 100644
--- a/test/integration/http2_integration_test.cc
+++ b/test/integration/http2_integration_test.cc
@@ -1076,6 +1076,21 @@ namespace {
 const int64_t TransmitThreshold = 100 * 1024 * 1024;
 } // namespace
 
+void Http2FloodMitigationTest::setNetworkConnectionBufferSize() {
+  // nghttp2 library has its own internal mitigation for outbound control frames. The mitigation is
+  // trigerred when there are more than 10000 PING or SETTINGS frames with ACK flag in the nghttp2
+  // internal outbound queue. It is possible to trigger this mitigation in nghttp2 before triggering
+  // Envoy's own flood mitigation. This can happen when a buffer larger enough to contain over 10K
+  // PING or SETTINGS frames is dispatched to the nghttp2 library. To prevent this from happening
+  // the network connection receive buffer needs to be smaller than 90Kb (which is 10K SETTINGS
+  // frames). Set it to the arbitrarily chosen value of 32K.
+  config_helper_.addConfigModifier([](envoy::config::bootstrap::v2::Bootstrap& bootstrap) -> void {
+    RELEASE_ASSERT(bootstrap.mutable_static_resources()->listeners_size() >= 1, "");
+    auto* listener = bootstrap.mutable_static_resources()->mutable_listeners(0);
+    listener->mutable_per_connection_buffer_limit_bytes()->set_value(32 * 1024);
+  });
+}
+
 void Http2FloodMitigationTest::beginSession() {
   setDownstreamProtocol(Http::CodecClient::Type::HTTP2);
   setUpstreamProtocol(FakeHttpConnection::Type::HTTP2);
@@ -1180,11 +1195,13 @@ INSTANTIATE_TEST_SUITE_P(IpVersions, Http2FloodMitigationTest,
                          TestUtility::ipTestParamsToString);
 
 TEST_P(Http2FloodMitigationTest, Ping) {
+  setNetworkConnectionBufferSize();
   beginSession();
   floodServer(Http2Frame::makePingFrame(), "http2.outbound_control_flood");
 }
 
 TEST_P(Http2FloodMitigationTest, Settings) {
+  setNetworkConnectionBufferSize();
   beginSession();
   floodServer(Http2Frame::makeEmptySettingsFrame(), "http2.outbound_control_flood");
 }
diff --git a/test/integration/http2_integration_test.h b/test/integration/http2_integration_test.h
index 6a8df8be37..6282ee13c4 100644
--- a/test/integration/http2_integration_test.h
+++ b/test/integration/http2_integration_test.h
@@ -62,6 +62,7 @@ protected:
                    Http2Frame::ResponseStatus expected_http_status, const std::string& flood_stat);
   Http2Frame readFrame();
   void sendFame(const Http2Frame& frame);
+  void setNetworkConnectionBufferSize();
   void beginSession();
 
   IntegrationTcpClientPtr tcp_client_;
-- 
2.11.0

